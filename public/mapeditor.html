<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KleptoKitty MapEditor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/picocss/1.5.10/pico.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Slackey&display=swap" rel="stylesheet">
    <style>
  /* Google fonts  ---------------------------- */
    .slackey {
      font-family: "Slackey", sans-serif;
      font-weight: 400;
      font-style: normal;
    }
  /* Layout  ---------------------------- */
:root {
  --primary: hotpink;
  --primary-hover: pink;
  --primary-focus: rgba(92, 107, 192, 0.125);
}
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100vh;
            overflow: hidden;
        }

        article { margin-top: 0; }
        h1, h2, h3 { font-weight: normal; font-family: "Slackey", sans-serif; }

        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: none;
            padding: 0;
            margin: 0;
        }

        /* Header Styles */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            background-color: var(--background-color);
            border-bottom: 1px solid var(--muted-border-color);
            flex-shrink: 0;
        }

        .header h1 {
            margin: 0;
            font-size: 1.5rem;
            text-shadow: -1px -1px 0 hotpink, 1px -1px 0 hotpink -1px 1px 0 hotpink 1px 1px 0 hotpink;
        }

        .nav-container {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .nav-container button {
            margin: 0;
            padding: 0.5rem 1rem;
        }

        .nav-container details {
            margin: 0;
        }

        .nav-container details summary {
            padding: 0.5rem 1rem;
            margin: 0;
            cursor: pointer;
        }

        .nav-container details a.active,
        .nav-container details a.active:hover {
            background: limegreen;
            color:#333;
        }

        /* Main Layout */
        .main-layout {
            background: #fff;
            display: flex;
            flex: 1;
            overflow: hidden;
            padding-bottom: 40px;
        }

        /* Toolbar */
        /* .toolbar { background: #00426f; } */
        .toolbar article { background: transparent; box-shadow: none; margin:10px 0 0 0; padding: 5px 5px 5px 0; }

        /* Main Content */
        .main-content {
            display: flex;
            flex: 1;
            overflow: auto;
            background: white;
            justify-content: center;
        }
      .main-content article { box-shadow: none; }

        /* Dropdown styling */
        details[role="list"] summary + ul {
            right: 0;
            left: auto;
            min-width: 150px;
        }


  /* Toolbar Tiles  ---------------------------- */
        .legend {
            /* padding: 20px; */
        }
        
        
        .tile-selector {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 2px;
        }
        .tile-selector div { text-align: left; }
        .tile-selector span {
          padding: 5px;
        }
        
        .tile-option {
            padding: 8px;
            margin-left: -3px;
            border: 2px solid rgba(0,0,0,.4);
            cursor: pointer;
            border-radius: 2px;
            text-align: center;
            font-weight: bold;
            font-size: 12px;
            transition: all 0.2s ease;
            background-color: skyblue;
            color: #222;
            background-repeat: no-repeat;
            background-size: 20px;
            background-position: 90% 90%;
        }
        
        .tile-option.selected {
          color: #222;
            border-color: crimson;
            background-color: rgba(255,255,255,.5);
        }
        
        .tile-option:hover {
            border-color: crimson;
            transform: scale(1.02);
        }
        
        .tile-option div:first-child {
            font-size: 11px;
            margin-bottom: 4px;
        }
        
        .tile-option div:last-child {
            font-size: 16px;
            font-weight: bold;
        }
        
  /* Map  ---------------------------- */
        .map-container {
            /* transform: scale(.75); */
            transform-origin: top center;
            min-height: 100%;
        }
        
        .map-grid {
            display: inline-grid;
            gap: 1px;
            background: #333;
            border: 2px solid #333;
            border-radius: 4px;
        }
        
        .tile {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            font-size: 13px;
            user-select: none;
        }
        
        .tile-0 { background: #fff; color: #333; }
        .tile-1 { background: #444; color: #fff; }
        .tile-P { background: #4CAF50; color: #fff; }
        .tile-L { background: #FFD700; color: #333; }
        .tile-K { background: orange; color: #333; }
        .tile-D { background: #f44336; color: #fff; }
        .tile-C { background: #600; color: #fff; }
        .tile-S { background: hotpink; color: #fff; }
        .tile-E { background: #9C27B0; color: #fff; }
        
  /* Map  ---------------------------- */
        .export-import { padding: 20px; }
        .export-import h3 { margin-top: 0; margin-bottom: 15px; color: #333; }
        
        .export-import textarea {
            width: 100%;
            height: 200px;
            margin: 10px 0;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            resize: vertical;
        }
        
        button.icon { background: rgba(255,255,255,0.1); border-color: rgba(255,255,255,0.3); transition: all .4s ease-in; }
        button.icon:hover { background: rgba(255,255,255,0.2); border-color: rgba(255,255,255,0.4); }
        button.icon span { display: none; }
        button.icon.muted { opacity: .5; background: transparent; border: none; }
        button.icon.muted:hover { opacity: 1; }
        
        button:active {
            transform: translateY(1px);
        }

        #map-info { position: fixed; bottom: 0; right: 20px; background: rgba(255, 255,255,0.5); color: #222; padding: 2px; }
        
        .status {
            position: absolute;
            bottom: 5px;
            left: 40%;
            margin-top: 10px;
            padding: 12px;
            display: none;
            font-weight: bold;
            font-size: 20px;
            box-sizing: border-box !important;
            border: 5px solid rgba(0,0,0,0.5);
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.note {
            background: #ccc;
            color: #444;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

  /* Modals  ---------------------------- */
  dialog article { width: 100%; background: transparent; border: none; box-shadow: none; }

        .controls {
            position: relative;
            background: #fff;
            padding: 30px;
            border-radius: 5px;
            border-bottom: 1px solid #eee;
        }

        .controls .close { position: absolute; top: 40px; right: 20px; }
        .controls .close:hover { color: black; cursor: pointer; }
        
        .controls h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 200%; 
            color: crimson;
  }
        
        .control-group {
          width: 45%; display: inline-block;
            margin-bottom: 15px;
        }
        
        .control-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        
        .control-group input {
            width: 80px;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .control-buttons {
            display: flex;
            gap: 10%;
            margin-top: 15px;
        }

dl {
  display: grid;
  grid-template-columns: 40% 60%;
  gap: 1em;
  color: #333;
}

dt {
  font-weight: bold; /* Optional styling for the term */
}

dd {
  margin: 0; /* Resets the default margin of the dd element */
}
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
        <h1>KleptoKitty MapEditor</h1>


            <nav class="nav-container">
                <button class="modal secondary icon" data-target="settings-modal"
                  data-tooltip="New map (shift + n)" data-placement="bottom">
                  <i data-lucide="map-plus"></i><span>New Map</span>
                </button>
                <button class="modal secondary icon" data-target="import-modal"
                  data-tooltip="Import map (shift + i)" data-placement="bottom">
                  <i data-lucide="import"></i><span>Import map</span>
                </button>
                <details role="list">
                    <summary>Levels</summary>
                    <ul role="listbox" class="levels">
                    </ul>
                </details>
                <button class="modal help icon muted" data-target="help-modal"
                data-tooltip="More info" data-placement="bottom">
                  <i data-lucide="info"></i><span>Help</span>
                </button>
            </nav>
        </header>

        <!-- Main Layout -->
        <div class="main-layout">
            
            <!-- toolbar -->
          <aside class="toolbar" id="toolbar">
              <article>
            <div class="legend">
                <div class="tile-selector">
                    <div class="tile-option selected" data-tile="0">
                        <div>Empty</div>
                        <div><span class="tile-0">0</span></div>
                    </div>
                    <div class="tile-option" data-tile="1">
                        <div>Wall</div>
                        <div><span class="tile-1">1</span></div>
                    </div>
                    <div class="tile-option" data-tile="P">
                        <div>Player</div>
                        <div><span class="tile-P">P</span></div>
                    </div>
                    <div class="tile-option" data-tile="K">
                        <div>Key</div>
                        <div><span class="tile-K">K</span></div>
                    </div>
                    <div class="tile-option" data-tile="D">
                        <div>Dog</div>
                        <div><span class="tile-D">D</span></div>
                    </div>
                    <div class="tile-option" data-tile="C">
                        <div>Camera</div>
                        <div><span class="tile-C">C</span></div>
                    </div>
                    <div class="tile-option" data-tile="L">
                        <div>Loot</div>
                        <div><span class="tile-L">L</span></div>
                    </div>
                    <div class="tile-option" data-tile="S">
                        <div>Spike</div>
                        <div><span class="tile-S">S</span></div>
                    </div>
                    <div class="tile-option" data-tile="E">
                        <div>Exit</div>
                        <div><span class="tile-E">E</span></div>
                    </div>
                </div>
            </div>
              </article>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
            <article data-theme="light">
              <div class="map-container" data-scale="1">
                  <div class="map-grid" id="mapGrid"></div>
              </div>
            </article>
            </main>
        </div>
    </div>

            <dialog id="settings-modal">
            <article>
            <div class="controls" style="display: block;">
                <div class="close"></div>
                <h3>Map Settings</h3>
                <form>
                <div class="control-group">
                    <label>Width:</label>
                    <input type="number" id="mapWidth" value="10" min="1" max="50">
                </div>
                <div class="control-group">
                    <label>Height:</label>
                    <input type="number" id="mapHeight" value="10" min="1" max="50">
                </div>
                <div class="control-buttons">
                    <button onclick="createMap()">Create Map</button>
                    <button class="contrast" onclick="clearMap()">Clear Map</button>
                </div>
                </form>
            </div>
            </article>
            </dialog>

            <dialog id="help-modal">
            <article>
            <div class="controls" style="display: block;">
                <div class="close"></div>
                <h3>Help</h3>
                <dl>
                  <dt>Import</dt>
                  <dd><kbd>Shift</kbd> + <kbd>I</kbd></dd>

                  <dt>Import</dt>
                  <dd><kbd>Shift</kbd> + <kbd>I</kbd></dd>

                  <dt>Export</dt>
                  <dd><kbd>Shift</kbd> + <kbd>E</kbd></dd>

                  <dt>Save</dt>
                  <dd><kbd>Shift</kbd> + <kbd>S</kbd></dd>

                  <dt>Zoom in</dt><dd><kbd>+</kbd></dd>
                  <dt>Zoom out</dt><dd><kbd>-</kbd></dd>
                </dl>
            </div>
            </article>
            </dialog>

            <dialog id="import-modal">
            <article>
            <div class="controls export-import">
                <div class="close"></div>
                <h3>Level data:</h3>
                <textarea id="arrayData" placeholder="Paste your map array here for import, or exported data will appear here..."></textarea>
                <div class="control-buttons">
                  <button onclick="exportMap()">Export</button>
                  <button onclick="importMap()">Import</button>
                </div>
            </div>
            </article>
            </dialog>

    <img src="t.gif" style="display:none;" />
    <div class="status" id="status"></div>
    <div id="map-info"></div>

    <script>
        let mapData = [];
        let selectedTile = '0';
        let mapWidth = 10;
        let mapHeight = 10;
        let isMouseDown = false;
        let isDragging = false;
        let history = [];

        let levels = [];
        let currentlyEditing = 1;

        // Initialize the map
        function initializeMap() {
            mapData = Array(mapHeight).fill().map(() => '0'.repeat(mapWidth));
            renderMap();
        }

        // Create a new map with specified dimensions
        function createMap() {

            mapWidth = parseInt(document.getElementById('mapWidth').value) || 10;
            mapHeight = parseInt(document.getElementById('mapHeight').value) || 10;
            
            // Clamp values
            mapWidth = Math.max(1, Math.min(50, mapWidth));
            mapHeight = Math.max(1, Math.min(50, mapHeight));
            
            document.getElementById('mapWidth').value = mapWidth;
            document.getElementById('mapHeight').value = mapHeight;
            
            initializeMap();

            showStatus('Map created successfully!', 'success');

        }

        // Clear the map (set all tiles to empty)
        function clearMap() {
            mapData = Array(mapHeight).fill().map(() => '0'.repeat(mapWidth));
            renderMap();
            showStatus('Map cleared!', 'success');
        }

        // Render the map grid
        function renderMap() {
            const grid = document.getElementById('mapGrid');
            grid.innerHTML = '';
            grid.style.gridTemplateColumns = `repeat(${mapWidth}, 1fr)`;

            document.getElementById('map-info').innerText = `Level ${currentlyEditing}: ${mapWidth} x ${mapHeight}`;

            for (let y = 0; y < mapHeight; y++) {
                const row = mapData[y];
                for (let x = 0; x < mapWidth; x++) {
                    const tileValue = row[x];
                    const tile = document.createElement('div');
                    tile.className = `tile tile-${tileValue}`;
                    tile.textContent = tileValue === '0' ? 'Â·' : tileValue;
                    tile.dataset.x = x;
                    tile.dataset.y = y;
                    
                    // Mouse event handlers for painting
                    tile.onmousedown = (e) => {
                        e.preventDefault();
                        isMouseDown = true;
                        isDragging = false;
                        placeTile(x, y);
                    };
                    
                    tile.onmouseenter = () => {
                        if (isMouseDown) {
                            isDragging = true;
                            placeTile(x, y);
                        }
                    };
                    
                    tile.onmouseup = () => {
                        isMouseDown = false;
                    };
                    
                    grid.appendChild(tile);
                }
            }
        }

        // Place a tile at the specified coordinates
        function placeTile(x, y) {
          const row = mapData[y];
          if (row[x] === selectedTile) { return; }

          const uniqueTiles = 'PKE'.split('');
          if (uniqueTiles.includes(selectedTile) && [...mapData].join('').includes(selectedTile)) {
            showStatus(`Map already has a ${selectedTile}!`, 'error');
            return;
          }

          mapData[y] = row.substring(0, x) + selectedTile + row.substring(x + 1);
          // store in history for undo
          const prev = history[history.length - 1];
          if (prev && prev[0] === y && prev[1] === row) {
          } else {
            history.push([y, row]);
            if (history.length > 20) {
              history.shift();
            }
          }

          renderMap();
        }

        // Handle tile selection
        document.querySelectorAll('.tile-option').forEach(option => {
            option.onclick = function() {
                document.querySelectorAll('.tile-option').forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                selectedTile = this.dataset.tile;
            };
        });

        // Export map to array format
        function exportMap() {
          const mapCopy = [...mapData];
          const el = document.getElementById('arrayData');
            const arrayString = JSON.stringify(mapCopy.reverse().join('-'), null, 2)+',';
            el.value = arrayString;
            el.select();
            el.setSelectionRange(0, 99999); // For mobile devices
            navigator.clipboard.writeText(el.value);
          console.log('EXPORTING');
            showStatus('Map exported to clipboard!', 'success');
        }

        // Import map from array format
        function importMap() {
            let arrayData = prepInput('arrayData');

            if (!arrayData) {
                showStatus('Please paste array data first!', 'error');
                return;
            }
            
            try {
                const importedData = arrayData.split('-').reverse();
                
                // Validate the imported data
                if (!Array.isArray(importedData) || importedData.length === 0) {
                    throw new Error('Invalid array format');
                }
                
                // Check if all rows are strings and have the same length
                const firstRowLength = importedData[0].length;
                if (!importedData.every(row => typeof row === 'string' && row.length === firstRowLength)) {
                    throw new Error('All rows must be strings with the same length');
                }
                
                // Validate tile values
                const validTiles = ['0', '1', 'P', 'K', 'D', 'E', 'C', 'L', 'M', 'S'];
                const hasInvalidTiles = importedData.some(row => 
                    [...row].some(tile => !validTiles.includes(tile))
                );
                
                if (hasInvalidTiles) {
                    throw new Error('Invalid tile values found. Use only: 0, 1, P, K, B, E');
                }
                
                // Import successful
                mapData = importedData;
                mapHeight = mapData.length;
                mapWidth = mapData[0].length;
                
                document.getElementById('mapWidth').value = mapWidth;
                document.getElementById('mapHeight').value = mapHeight;
                
                renderMap();
                showStatus(`Map (${mapWidth}x${mapHeight}) imported successfully!`, 'success');
                
            } catch (error) {
                showStatus(`Import failed: ${error.message}`, 'error');
            }
        }

        function saveAll() {
            let mapCopy = [...mapData];
            let mapArray = JSON.stringify(mapCopy.reverse().join('-'), null, 2)+',';
            levels[currentlyEditing] = mapArray;

            let levelsCopy = [...levels].join('+').replaceAll(',', '').replaceAll('"', '');
          window.levelsCopy = levelsCopy;

            const payload = {levels: levelsCopy}

            fetch('/api/data', {
              method: 'POST', // or 'PUT'
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(payload),
            })
            .then(response => response.json())
            .then((data) =>  {
              showStatus(`Levels saved`, 'success');
            })
            .catch((error) => {
              showStatus(`Error saving`, 'error');
              console.error('Error:', error);
            });

        }

        function saveMap() {
          console.log(levels);
          const mapCopy = [...mapData];
          const mapArray = JSON.stringify(mapCopy.reverse().join('-'), null, 2)+',';
          const payLoad = {mapArray};
          fetch('/api/data', {
            method: 'POST', // or 'PUT'
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(payLoad),
          })
          .then(response => response.json())
          .then(data => console.log('D: ', data))
          .catch((error) => {
            console.error('Error:', error);
          });

            showStatus(`Map saved to testlevel.js`, 'success');
        }

        // Show status message
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
            
            setTimeout(() => {
                status.style.display = 'none';
            }, 3000);
        }

        // Initialize the editor
        createMap();

        // Global mouse event handlers to handle mouse release outside of tiles
        document.addEventListener('mouseup', () => {
            isMouseDown = false;
        });

        // Prevent context menu on right click for better user experience
        document.addEventListener('contextmenu', (e) => {
            if (e.target.classList.contains('tile')) {
                e.preventDefault();
            }
        });

        // Prevent text selection while dragging
        document.addEventListener('selectstart', (e) => {
            if (isMouseDown && e.target.classList.contains('tile')) {
                e.preventDefault();
            }
        });

        function prepInput(elementId) {
            let arrayData = document.getElementById('arrayData').value.trim();
            let cleaned = arrayData.replace(/\s/g, "");
            cleaned = cleaned.replaceAll(',', '');
            cleaned = cleaned.replaceAll('"', '');

            return cleaned;
        }

let keys = '01PKDGLSEC'.split('')
  keys.forEach((k, i) => {
        keys[i] = (k == '0' || k == '1') ? 'Digit'+k : 'Key'+k; 
});

addEventListener('keyup', (e) => {

      document.querySelectorAll('details').forEach((d => d.open = false))
      const modalOpen = document.documentElement.getAttribute('class') === 'modal-is-open';
      const mapContainer = document.querySelector('.map-container');
      let scale = mapContainer.getAttribute('data-scale') || 1;
      scale = parseFloat(scale);

      if (e.code === 'Equal' || e.code === 'Minus') {
          let factor = (e.code === 'Equal') ? 1.1 : 0.9;
          scale *= factor;
          mapContainer.style.transform = `scale(${scale})`
          mapContainer.setAttribute('data-scale', scale);
      }

      if (e.code === 'KeyZ' && e.ctrlKey) {
            const lastAction = history.pop();
            if (lastAction) {
              mapData[lastAction[0]] = lastAction[1];
              renderMap();
            } else {
              showStatus('Already at last action', 'note');
            }
      }
      if (e.code === 'KeyZ' && e.ctrlKey && e.shiftKey) {
            console.log('redo');
      }
      if (e.code === 'KeyS' && e.shiftKey) {
            saveAll();
      }
      if (e.code === 'KeyE' && e.shiftKey) {
          exportMap();
      }
      if (e.code === 'KeyH' && e.shiftKey) {
            document.getElementById('help-modal').showModal();
      }
      if (e.code === 'KeyN' && e.shiftKey) {
            document.getElementById('settings-modal').showModal();
      }
      if (e.code === 'KeyI' && e.shiftKey) {
            document.getElementById('import-modal').showModal();
      }

      if (!modalOpen && keys.includes(e.code) && !e.shiftKey) {
          let k = e.code.split('').pop();
          document.querySelector('.tile-option[data-tile="'+k+'"]').click();
      }
});

async function loadLevels() {
  try {
    const response = await fetch('/api/data');
    const json = await response.json();
    return json;
  } catch (error) {
    console.error('Error:', error);
  }
}

loadLevels()
    .then((data) => {
      levels = data.levels;
      // levels.unshift(data.testlevel);
      document.querySelector('#arrayData').value = levels[0];
      importMap();
      let html = '';
      currentlyEditing = 0;
      levels.forEach((level, i) => {
              let title = `Level ${i+1}`;
              html += `<li><a ${i === 0 ? 'class="active"' : ''} href="#" data-level=${i}>${title}</a></li>`;
      });
      document.querySelector('ul.levels').innerHTML = html;
            document.querySelector('ul.levels').addEventListener('click', (e) => {
              let prev = currentlyEditing;
              let mapCopy = [...mapData];
              let mapArray = JSON.stringify(mapCopy.reverse().join('-'), null, 2)+',';
              history = [];

              levels[prev] = mapArray;
              currentlyEditing = e.target.dataset.level;
              document.querySelector(`[data-level="${prev}"]`).classList.remove('active');
              e.target.classList = 'active';
              console.log('editing', currentlyEditing, 'Prev', prev, e.target);
              document.querySelector('#arrayData').value = levels[currentlyEditing];
              importMap();
            }, false);
    });

    </script>

<script>

  const rows = 32/8;
  const tiles = {
    player: 0,
    key: 3,
    spike: 5,
    wall: 9,
    dog: 13,
    loot: 11,
    camera: 12
  }

  const getCoords = (tile) => {
    let x = (tile%rows)*8;
    let y = Math.floor(tile/rows)*8;
    return {x, y};
  }
  const makeImage = (src, name, x, y) => {
    let size = 64;
    const canvas = document.createElement('canvas');
    canvas.width = size;
    canvas.height = size;
    const ctx = canvas.getContext('2d');
    ctx.imageSmoothingEnabled= false
    ctx.drawImage(src, x, y, 8, 8, 0, 0, size, size);
    const i = document.createElement('img');
    i.title = name;
    i.id = name;
    i.src = canvas.toDataURL('image/png');
    i.style.imageRendering = 'pixelated';
    i.style.display = 'none';
    document.body.appendChild(i);
  };

  let size = 64;
  const canvas = document.createElement('canvas');
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext('2d');
  const img = new Image();
  img.onload = () => {
    for(let t in tiles) {
      let tileNumber = tiles[t];
      let {x, y} = getCoords(tileNumber);
      makeImage(img, t, x, y);
    }
  };
  img.src = 't.gif';

  window.setTimeout(() => {
    document.querySelector('.tile-option[data-tile="P"]')
      .style.backgroundImage = `url(${document.querySelector('img#player').src})`;

    document.querySelector('.tile-option[data-tile="S"]')
      .style.backgroundImage = `url(${document.querySelector('img#spike').src})`;

    document.querySelector('.tile-option[data-tile="K"]')
      .style.backgroundImage = `url(${document.querySelector('img#key').src})`;

    document.querySelector('.tile-option[data-tile="C"]')
      .style.backgroundImage = `url(${document.querySelector('img#camera').src})`;

    document.querySelector('.tile-option[data-tile="L"]')
      .style.backgroundImage = `url(${document.querySelector('img#loot').src})`;

    document.querySelector('.tile-option[data-tile="D"]')
      .style.backgroundImage = `url(${document.querySelector('img#dog').src})`;
  }, 1000);

  // modals
const isOpenClass = "modal-is-open";
const openingClass = "modal-is-opening";
const closingClass = "modal-is-closing";
const scrollbarWidthCssVar = "--pico-scrollbar-width";
const animationDuration = 400; // ms
let visibleModal = null;


  document.querySelectorAll('dialog .close').forEach((btn) => {
    btn.addEventListener('click', (e) => {
      closeModal(document.querySelector('[open]'));
    });
  });

  document.querySelectorAll('.modal').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const modal = document.getElementById(event.currentTarget.dataset.target);
      if (!modal) return;
      modal && (modal.open ? closeModal(modal) : openModal(modal));
    });

  });

// Open modal
const openModal = (modal) => {
  const { documentElement: html } = document;
  const scrollbarWidth = getScrollbarWidth();
  if (scrollbarWidth) {
    html.style.setProperty(scrollbarWidthCssVar, `${scrollbarWidth}px`);
  }
  html.classList.add(isOpenClass, openingClass);
  setTimeout(() => {
    visibleModal = modal;
    html.classList.remove(openingClass);
  }, animationDuration);
  modal.showModal();
};

// Close modal
const closeModal = (modal) => {
  visibleModal = null;
  const { documentElement: html } = document;
  html.classList.add(closingClass);
  setTimeout(() => {
    html.classList.remove(closingClass, isOpenClass);
    html.style.removeProperty(scrollbarWidthCssVar);
    modal.close();
  }, animationDuration);
};

// Close with a click outside
document.addEventListener("click", (event) => {
  if (visibleModal === null) return;
  const modalContent = visibleModal.querySelector("article");
  const isClickInside = modalContent.contains(event.target);
  !isClickInside && closeModal(visibleModal);
});


// Close with Esc key
document.addEventListener("keydown", (event) => {
  if (event.key === "Escape" && visibleModal) {
    closeModal(visibleModal);
  }
});

// Get scrollbar width
const getScrollbarWidth = () => {
  const scrollbarWidth = window.innerWidth - document.documentElement.clientWidth;
  return scrollbarWidth;
};

// Is scrollbar visible
const isScrollbarVisible = () => {
  return document.body.scrollHeight > screen.height;
};

document.querySelector('#settings-modal form')
    .addEventListener('submit', (e) => {
      e.preventDefault();
      createMap();
      // const modal = document.getElementById(event.currentTarget.dataset.target);

      document.querySelectorAll('dialog').forEach(m => closeModal(m));
      return false;
    }, false);


</script>

<script src="https://unpkg.com/lucide@latest"></script>
<script> lucide.createIcons(); </script>

    </body>
  </html>
